<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SignOS Menu v5.3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="signos-core.js"></script>
</head>
<body class="bg-gray-100 min-h-screen font-sans flex flex-col">

    <div class="bg-gray-800 text-white px-6 py-2 flex justify-between items-center text-xs shadow-md shrink-0">
        <div class="flex gap-4">
            <span class="tracking-wide">USER: <span class="font-bold text-gray-200 uppercase" id="auth-user">---</span></span>
            <span class="tracking-wide">ROLE: <span class="font-bold text-blue-400 uppercase" id="auth-role">---</span></span>
        </div>
        <button onclick="logout()" class="font-bold text-red-400 hover:text-white uppercase tracking-wider text-[10px] border border-red-900/50 hover:bg-red-900/50 px-2 py-1 rounded transition">Logout</button>
    </div>

    <div class="max-w-6xl mx-auto p-8 flex-1 w-full">
        
        <div class="mb-8 flex justify-between items-end">
            <div>
                <h1 class="text-3xl font-bold text-gray-800 tracking-tight">SignOS Dashboard</h1>
                <p class="text-gray-500 text-sm mt-1" id="env-badge">Loading Environment...</p>
            </div>
            
            <div id="super-badge" class="hidden bg-purple-600 text-white px-3 py-1 rounded text-[10px] font-bold tracking-widest shadow-lg animate-pulse">
                SUPER USER ACTIVE
            </div>
        </div>

        <div id="menu-container" class="space-y-8">
            <div class="text-center py-20 text-gray-400 animate-pulse tracking-widest text-xs font-bold">
                CONNECTING TO BACKEND...
            </div>
        </div>

    </div>

    <div class="bg-white border-t border-gray-200 mt-auto">
        <div class="max-w-6xl mx-auto px-8 py-4 flex justify-between items-center">
            <p class="text-[10px] text-gray-400">SignOS v5.2 | &copy; 2026 SignStoreERP</p>
            <div class="flex gap-4 opacity-50 grayscale hover:grayscale-0 transition duration-300">
                <a href="admin_roadmap.html" class="text-xl hover:scale-110 transition" title="Roadmap">üöß</a>
                <a href="admin_viewer.html" class="text-xl hover:scale-110 transition" title="System Logs">‚öôÔ∏è</a>
                <a href="admin_backup.html" class="text-xl hover:scale-110 transition" title="Backup Data">üíæ</a>
                <a href="docs.html" class="text-xl hover:scale-110 transition" title="Documentation">üìú</a>
            </div>
        </div>
    </div>

<script>
    // --- CONFIG ---
    // Icons for standard modules (Tailwind colors)
    const ICON_STYLES = {
        blue: "bg-blue-50 text-blue-600 group-hover:bg-blue-600 group-hover:text-white",
        green: "bg-green-50 text-green-600 group-hover:bg-green-600 group-hover:text-white",
        purple: "bg-purple-50 text-purple-600 group-hover:bg-purple-600 group-hover:text-white",
        red: "bg-red-50 text-red-600 group-hover:bg-red-600 group-hover:text-white",
        orange: "bg-orange-50 text-orange-600 group-hover:bg-orange-600 group-hover:text-white",
        slate: "bg-slate-50 text-slate-600 group-hover:bg-slate-600 group-hover:text-white",
        teal: "bg-teal-50 text-teal-600 group-hover:bg-teal-600 group-hover:text-white",
        indigo: "bg-indigo-50 text-indigo-600 group-hover:bg-indigo-600 group-hover:text-white",
        pink: "bg-pink-50 text-pink-600 group-hover:bg-pink-600 group-hover:text-white",
        yellow: "bg-yellow-50 text-yellow-600 group-hover:bg-yellow-500 group-hover:text-white",
        gray: "bg-gray-100 text-gray-600 group-hover:bg-gray-600 group-hover:text-white"
    };

    window.onload = async function() {
        const user = sessionStorage.getItem('signos_user');
        const role = sessionStorage.getItem('signos_role');
        const permsRaw = sessionStorage.getItem('signos_perms');

        if (!user) { window.location.href = 'index.html'; return; }

        document.getElementById('auth-user').innerText = user;
        document.getElementById('auth-role').innerText = role;

   // Environment Badge
    const envEl = document.getElementById('env-badge');
    if (IS_DEV_ENV) {
        // ADDED BACKTICKS BELOW
        envEl.innerHTML = `<span class="text-orange-600 font-bold">‚ö†Ô∏è DEVELOPMENT ENVIRONMENT</span> | <span class="text-gray-400">${clientIP}</span>`;
    } else {
        // ADDED BACKTICKS BELOW
        envEl.innerHTML = `<span class="text-green-600 font-bold">‚óè LIVE SYSTEM</span> | <span class="text-gray-400">${clientIP}</span>`;
    }

        // Super User Badge
        if (role === 'SUPER') {
            document.getElementById('super-badge').classList.remove('hidden');
        }

        // Log Telemetry
        fetch(`${SCRIPT_URL}?tab=SYS_Modules&req=table&action=menu_load&user=${user}&role=${role}&ip=${clientIP}`, {mode: 'no-cors'});

        // Load Modules
        await loadModules(role);
    };

    async function loadModules(role) {
        const container = document.getElementById('menu-container');
        
        try {
            const response = await fetch(`${SCRIPT_URL}?req=table&tab=SYS_Modules`);
            const data = await response.json();

            if (!data || data.length === 0) {
                container.innerHTML = `<div class="text-center text-red-500 font-bold">ERROR: Could not load modules.</div>`;
                return;
            }

            container.innerHTML = ""; // Clear loader
            
            // Get unique categories
            const categories = [...new Set(data.map(item => item.Category))].filter(Boolean);

            // Render Sections
            categories.forEach(cat => {
                const section = document.createElement('div');
                section.className = "bg-white rounded-2xl shadow-sm border border-gray-200 p-6";
                
                const title = document.createElement('h2');
                title.className = "text-xs font-bold text-gray-400 uppercase tracking-widest mb-4 border-b border-gray-100 pb-2";
                title.innerText = cat;
                section.appendChild(title);

                const grid = document.createElement('div');
                grid.className = "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4";

                // Filter modules for this category
                const modules = data.filter(m => m.Category === cat);

       modules.forEach(mod => {
            // 1. ROLE NORMALIZATION
            // Treat SUPER users as ADMINs for permission checks
            const checkRole = (role === 'SUPER') ? 'ADMIN' : role;

            // 2. TWIN-ENGINE VISIBILITY (The Fix)
            // If we are in Dev Env, check 'Dev_ADMIN'. If Live, check 'Live_ADMIN'.
            const envPrefix = IS_DEV_ENV ? 'Dev_' : 'Live_';
            const permKey = envPrefix + checkRole; 
            const isVisible = String(val(mod, permKey)).toUpperCase() === 'TRUE';

            // 3. SUPER USER OVERRIDE
            // If not visible, kick out... UNLESS you are Super User.
            if (!isVisible && role !== 'SUPER') return;

            // 4. VERSION LOGIC & GHOST PROTOCOL
            const devVer = val(mod, 'Dev_Ver');
            const liveVer = val(mod, 'Live_Ver');
            let targetVer = IS_DEV_ENV ? (devVer || 'v0.0') : (liveVer || 'v0.0');

            // Ghost Protocol: If on LIVE and no version exists, hide it entirely.
            // This prevents broken links for features that are only in Dev.
            if (!IS_DEV_ENV && (!liveVer || liveVer === '')) return;

            // 5. RENDER SETUP
            const displayName = val(mod, 'Display_Name');
            const fileLink = val(mod, 'File_Link');
            const iconColor = val(mod, 'Icon');
            const iconPath = val(mod, 'Icon_Path');

            // 6. TARGETING MODE
            // Admins go to 'dev' mode on the App repo, 'sales' mode on the Live repo.
            let targetMode = (role === 'PROD') ? 'production' : (role === 'ADMIN' || role === 'SUPER' ? 'dev' : 'sales');

            // 7. BUILD CARD
            const link = document.createElement('a');
            link.href = `${fileLink}?mode=${targetMode}`;
            link.className = "block bg-white p-5 rounded-xl shadow-sm border border-gray-200 hover:border-blue-500 hover:shadow-md transition group relative";

            const colorClass = ICON_STYLES[(iconColor || 'blue').toLowerCase()] || ICON_STYLES['blue'];
            const verBg = IS_DEV_ENV ? 'bg-orange-100 text-orange-700' : 'bg-gray-100 text-gray-500';

            // Draft Badge: Show if hidden via permissions but visible to Super
            const draftBadge = (!isVisible && role === 'SUPER') 
                ? `<div class="absolute top-2 right-2 text-[9px] font-bold bg-purple-100 text-purple-600 px-2 py-0.5 rounded border border-purple-200">HIDDEN</div>` 
                : '';

            const iconHtml = iconPath 
                ? `<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="${iconPath}"></path></svg>`
                : `<span class="text-xl font-bold">‚óè</span>`;

            link.innerHTML = `
                ${draftBadge}
                <div class="flex items-center gap-4">
                    <div class="w-10 h-10 rounded-lg flex items-center justify-center transition ${colorClass}">
                        ${iconHtml}
                    </div>
                    <div>
                        <h3 class="font-bold text-gray-800 text-sm group-hover:text-blue-600 transition">${displayName}</h3>
                        <div class="mt-1 flex items-center gap-2">
                            <span class="text-[10px] font-mono px-1.5 py-0.5 rounded ${verBg}">${targetVer}</span>
                        </div>
                    </div>
                </div>
            `;
            grid.appendChild(link);
        });

                if (grid.children.length > 0) {
                    section.appendChild(grid);
                    container.appendChild(section);
                }
            });

        } catch (e) {
            console.error(e);
            container.innerHTML = `<div class="text-center text-red-500 font-bold p-10">
                Connection Failed.<br>
                <span class="text-xs font-normal text-gray-500">${e.message}</span>
            </div>`;
        }
    }

    // Helper to safely get value from object keys (case-insensitive)
    function val(obj, key) {
        if (!obj) return "";
        return obj[key] || obj[key.toUpperCase()] || obj[key.toLowerCase()] || "";
    }
</script>

</body>
</html>


