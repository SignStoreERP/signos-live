<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pricing Simulator v3.0</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="signos-core.js"></script>

<script src="logic_yard.js"></script>
<script src="logic_banner.js"></script>
<script src="logic_acm.js"></script>
<script src="logic_pvc.js"></script>
<script src="logic_coro.js"></script>
<script src="logic_foam.js"></script>
<script src="logic_decal.js"></script>
<script src="logic_cut.js"></script>
<script src="logic_wrap.js"></script>
<script src="logic_wall.js"></script>

<style>
input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
.toggle-checkbox:checked { right: 0; border-color: #2563EB; }
.toggle-checkbox:checked + .toggle-label { background-color: #2563EB; }

/* Custom Scrollbars */
.custom-scroll { scrollbar-width: thin; scrollbar-color: #cbd5e1 #f8fafc; }
.custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
.custom-scroll::-webkit-scrollbar-track { background: #f8fafc; }
.custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }

/* Smooth Accordion Transitions */
.panel-content { transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out, margin 0.3s ease-in-out; max-height: 800px; opacity: 1; overflow-y: auto; overflow-x: hidden; }
.panel-content.closed { max-height: 0; opacity: 0; margin-top: 0; pointer-events: none; }
.chevron { transition: transform 0.3s ease-in-out; }
.chevron.closed { transform: rotate(-90deg); }
</style>
</head>
<body class="bg-gray-200 h-[100dvh] w-full flex flex-col font-sans p-2 sm:p-4 md:p-6 items-center justify-center overflow-hidden">

<div id="main-card" class="w-full max-w-[1400px] h-full flex flex-col bg-white rounded-xl shadow-2xl border border-gray-300 overflow-hidden relative">

<div class="bg-gray-900 px-4 py-3 flex flex-col md:flex-row md:items-center justify-between gap-3 shrink-0 z-20">
    <div class="flex items-center justify-center md:justify-start gap-3 flex-wrap">
        <div class="flex items-center gap-2 bg-gray-800 p-1 rounded-lg border border-gray-700 shadow-inner">
            <span class="text-[10px] font-bold text-gray-400 uppercase ml-2 tracking-widest">Engine:</span>
            <select id="sim-module" class="bg-gray-900 text-white border border-gray-600 rounded p-1 text-xs font-bold outline-none cursor-pointer focus:border-blue-500 transition" onchange="loadModuleData()">
                <option value="YARD">Yard Signs (Coro)</option>
                <option value="BANNER">Vinyl Banners</option>
                <option value="ACM">ACM Signs (Metal)</option>
                <option value="CORO">Custom Coroplast</option>
                <option value="FOAM">Foam Core</option>
                <option value="DECAL">Decals & Stickers</option>
                <option value="CUT">Cut Vinyl</option>
                <option value="WRAP">Wraps & Walls</option>
                <option value="WALL">Interior Wall Wraps</option>
                <option value="PVC">PVC Signs</option>
            </select>
        </div>
        <div id="loader" class="hidden items-center gap-2 text-yellow-400 text-[10px] font-bold uppercase tracking-widest animate-pulse">
            <svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
            Loading...
        </div>
    </div>

    <div class="flex flex-wrap items-center justify-center gap-2 bg-gray-800 px-3 py-1.5 rounded-lg border border-gray-700 shadow-inner shrink-0">
        <span class="text-[9px] font-bold text-gray-400 uppercase tracking-widest hidden sm:inline">Range</span>
        <input type="number" id="range-start" value="1" class="w-12 bg-gray-900 border border-gray-600 rounded px-1 py-0.5 text-center text-xs font-bold text-white outline-none">
        <span class="text-gray-500 font-bold">-</span>
        <input type="number" id="range-end" value="100" class="w-12 bg-gray-900 border border-gray-600 rounded px-1 py-0.5 text-center text-xs font-bold text-white outline-none">
        <span class="text-[9px] font-bold text-gray-500 uppercase ml-2 hidden sm:inline">Step</span>
        <input type="number" id="range-step" value="5" class="w-10 bg-gray-900 border border-gray-600 rounded px-1 py-0.5 text-center text-xs font-bold text-white outline-none" placeholder="Stp">
    </div>

    <div class="flex justify-center gap-2 shrink-0">
        <button onclick="resetDefaults()" class="bg-gray-700 hover:bg-gray-600 text-gray-200 font-bold px-3 py-1.5 rounded shadow transition text-[9px] uppercase tracking-widest border border-gray-600">Reset</button>
        <button onclick="exportData()" class="bg-gray-700 hover:bg-gray-600 text-green-400 font-bold px-3 py-1.5 rounded shadow transition text-[9px] uppercase tracking-widest border border-gray-600 flex items-center gap-1">
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
            Export
        </button>
        <button onclick="runSimulation()" id="btn-run" class="bg-blue-600 hover:bg-blue-500 text-white font-bold px-4 py-1.5 rounded shadow-lg transition text-[10px] uppercase tracking-widest ml-1">Run Sim</button>
    </div>
</div>

<div class="flex-1 flex flex-col md:flex-row min-h-0 bg-gray-100 overflow-y-auto md:overflow-hidden custom-scroll">

    <div class="flex flex-col w-full md:flex-1 shrink-0 min-w-0 bg-white relative z-0 border-b md:border-b-0 border-gray-300">
        
        <div class="bg-gray-50 border-b border-gray-200 px-4 py-2 flex flex-col sm:flex-row justify-between items-center gap-2 shrink-0 shadow-sm">
            <h2 class="text-xs font-black text-gray-700 uppercase tracking-widest flex items-center gap-2">
                <span class="w-2 h-2 rounded-full bg-blue-500"></span> Profitability Curve
            </h2>
            
            <div class="relative flex bg-slate-200 p-1 rounded-full border border-slate-300 shadow-inner w-full sm:w-60 shrink-0 overflow-hidden">
                <div id="slider-pill" class="absolute top-1 bottom-1 w-[calc(50%-4px)] bg-white rounded-full shadow border border-slate-200/50 transition-transform duration-300 ease-out z-0 translate-x-0"></div>
                
                <div onclick="setViewMode('margin')" id="btn-mode-margin" class="flex-1 py-1.5 text-center text-[10px] font-black uppercase tracking-widest cursor-pointer transition-colors duration-300 ease-out select-none z-10 flex items-center justify-center text-blue-700">Margin</div>
                <div onclick="setViewMode('profit')" id="btn-mode-profit" class="flex-1 py-1.5 text-center text-[10px] font-black uppercase tracking-widest cursor-pointer transition-colors duration-300 ease-out select-none z-10 flex items-center justify-center text-slate-500 hover:text-slate-800">Net Profit</div>
            </div>
        </div>

        <div class="relative p-2 md:p-4 h-[300px] sm:h-[400px] md:h-auto md:flex-1 shrink-0">
            <canvas id="priceChart"></canvas>
        </div>

        <div class="bg-white border-t border-b border-gray-200 px-4 py-2 flex flex-wrap justify-center gap-4 sm:gap-6 text-[9px] font-bold text-gray-500 uppercase tracking-widest shrink-0 z-10 relative shadow-sm">
            <div class="flex items-center gap-1.5"><span class="w-3 h-3 bg-blue-500 rounded-sm shadow-inner"></span> Unit Retail</div>
            <div class="flex items-center gap-1.5"><span class="w-3 h-3 bg-red-400 rounded-sm shadow-inner border border-red-500 border-dashed"></span> Unit Cost</div>
            <div class="flex items-center gap-1.5"><span class="w-3 h-3 bg-yellow-400 rounded-sm shadow-inner opacity-80"></span> <span id="lbl-legend-profit">Margin %</span></div>
        </div>

        <div class="h-auto md:h-1/3 min-h-[250px] bg-slate-50 flex flex-col shrink-0 relative z-0">
            <div class="bg-slate-200 border-b border-slate-300 px-4 py-1.5 flex justify-between items-center shadow-inner shrink-0">
                <span class="text-[10px] font-black text-slate-700 uppercase tracking-widest">Math Receipt: <span class="text-blue-600">Qty <span id="rec-qty">--</span></span></span>
                <span class="text-[9px] text-slate-500 italic font-medium hidden sm:inline">Tap chart bars to inspect qty</span>
            </div>
            
            <div id="rec-profit-bar" class="bg-white border-b border-slate-200 px-4 py-2.5 flex justify-between items-center shrink-0 shadow-sm hidden">
                <span class="text-[10px] font-black text-slate-500 uppercase tracking-widest flex items-center gap-2">
                    <svg class="w-3 h-3 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    Total Order Profit
                </span>
                <span id="rec-total-profit" class="text-xl font-black tracking-tight">---</span>
            </div>

            <div class="flex-1 overflow-visible md:overflow-y-auto custom-scroll p-4 md:p-6" id="rec-content">
                <div class="text-center text-gray-400 text-xs mt-10 font-bold uppercase tracking-widest opacity-50">Run simulation to view math</div>
            </div>
        </div>
    </div>

    <div class="w-full md:w-96 lg:w-[420px] bg-white md:border-l border-gray-300 flex flex-col shrink-0 z-10 md:shadow-[-4px_0_15px_-3px_rgba(0,0,0,0.1)] relative">
        <div class="overflow-visible md:overflow-y-auto custom-scroll flex-1 h-full pb-10 md:pb-0">
            
            <div class="bg-gray-50 border-b border-gray-200">
                <div class="px-5 py-3 flex items-center justify-between cursor-pointer hover:bg-gray-100 transition" onclick="togglePanel('config-container', 'cfg-icon')">
                    <h3 class="text-[10px] font-black text-gray-700 uppercase tracking-widest flex items-center gap-2">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg>
                        Product Configuration
                    </h3>
                    <svg id="cfg-icon" class="chevron w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </div>
                <div class="panel-content px-5 pb-4" id="config-container"></div>
            </div>

            <div class="bg-blue-50/50 border-b border-blue-100">
                <div class="px-5 py-3 flex items-center justify-between cursor-pointer hover:bg-blue-50 transition" onclick="togglePanel('retail-container', 'ret-icon')">
                    <div class="flex flex-col">
                        <h3 class="text-[10px] font-black text-blue-800 uppercase tracking-widest">Market Drivers</h3>
                        <span class="text-[9px] text-blue-500 font-medium">Area curves, markups, discounts.</span>
                    </div>
                    <svg id="ret-icon" class="chevron w-4 h-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </div>
                <div class="panel-content px-5 pb-4" id="retail-container"></div>
            </div>

            <div class="bg-red-50/50">
                <div class="px-5 py-3 flex items-center justify-between cursor-pointer hover:bg-red-50 transition" onclick="togglePanel('cost-container', 'cost-icon')">
                    <div class="flex flex-col">
                        <h3 class="text-[10px] font-black text-red-800 uppercase tracking-widest">Physics Drivers</h3>
                        <span class="text-[9px] text-red-500 font-medium">Substrate, ink, labor speeds, prep.</span>
                    </div>
                    <svg id="cost-icon" class="chevron w-4 h-4 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </div>
                <div class="panel-content px-5 pb-4" id="cost-container"></div>
            </div>

        </div>
    </div>
</div>

</div>

<script>
let chartInstance = null;
let currentBackend = {};
let simulationData = [];
let currentViewMode = 'margin'; // 'margin' or 'profit'

window.onload = function() {
    if(typeof injectHeader === 'function') injectHeader("Pricing Simulator");
    loadModuleData();
};

// --- UI INTERACTION ---
function togglePanel(panelId, iconId) {
    document.getElementById(panelId).classList.toggle('closed');
    document.getElementById(iconId).classList.toggle('closed');
}

function setViewMode(mode) {
    currentViewMode = mode;
    
    const btnMargin = document.getElementById('btn-mode-margin');
    const btnProfit = document.getElementById('btn-mode-profit');
    const pill = document.getElementById('slider-pill');
    
    // Explicitly defining Tailwind classes to prevent compiler crashes
    const activeClass = "flex-1 py-1.5 text-center text-[10px] font-black uppercase tracking-widest cursor-pointer transition-colors duration-300 ease-out select-none z-10 flex items-center justify-center text-blue-700";
    const inactiveClass = "flex-1 py-1.5 text-center text-[10px] font-black uppercase tracking-widest cursor-pointer transition-colors duration-300 ease-out select-none z-10 flex items-center justify-center text-slate-500 hover:text-slate-800";
    
    if (mode === 'margin') {
        btnMargin.className = activeClass;
        btnProfit.className = inactiveClass;
        pill.style.transform = "translateX(0)";
        document.getElementById('lbl-legend-profit').innerText = "Margin %";
    } else {
        btnProfit.className = activeClass;
        btnMargin.className = inactiveClass;
        pill.style.transform = "translateX(100%)";
        document.getElementById('lbl-legend-profit').innerText = "Net Profit $";
    }
    
    if (simulationData.length > 0) renderChart();
}

// --- GET ACTIVE CONFIG ---
function getActiveConfig() {
    const modKey = document.getElementById('sim-module').value;
    return window[modKey + '_CONFIG'];
}

// --- LOAD DATA & RENDER UI ---
async function loadModuleData() {
    const config = getActiveConfig();
    if (!config) { alert("Logic configuration missing for this module."); return; }

    const btn = document.getElementById('btn-run');
    const loader = document.getElementById('loader');
    
    btn.classList.add('hidden');
    loader.classList.replace('hidden', 'flex');

    renderControls(config.controls);
    document.getElementById('cost-container').innerHTML = `<span class="text-xs text-red-300 font-bold animate-pulse">Fetching backend data...</span>`;
    document.getElementById('retail-container').innerHTML = `<span class="text-xs text-blue-300 font-bold animate-pulse">Fetching backend data...</span>`;

    try {
        const u = sessionStorage.getItem('signos_user') || 'Admin';
        const res = await fetch(`${SCRIPT_URL}?req=view_module&tab=${config.tab}&user=${u}`);
        const data = await res.json();

        if(data.error) throw new Error(data.error);
        currentBackend = data;

        renderCostInputs(config.costs, data);
        renderRetailInputs(config.retails, data);

        btn.classList.remove('hidden');
        loader.classList.replace('flex', 'hidden');

        // --- UPDATE HEADER TO ONLINE ---
        const statusText = document.getElementById("status-text");
        const statusDot = document.getElementById("status-dot");
        if(statusText) {
            statusText.innerText = "ONLINE";
            statusText.className = "font-bold text-green-500";
        }
        if(statusDot) {
            statusDot.className = "w-2 h-2 rounded-full bg-green-500";
            statusDot.classList.remove("animate-pulse");
        }

        runSimulation();

    } catch(e) {
        alert("Load Error: " + e.message);
        loader.classList.replace('flex', 'hidden');
        btn.classList.remove('hidden');
        btn.innerText = "ERROR";
        
        // --- SET HEADER TO ERROR STATUS ---
        const statusText = document.getElementById("status-text");
        const statusDot = document.getElementById("status-dot");
        if(statusText) {
            statusText.innerText = "OFFLINE";
            statusText.className = "font-bold text-red-500";
        }
        if(statusDot) statusDot.className = "w-2 h-2 rounded-full bg-red-500";
    }
}

function resetDefaults() {
    const config = getActiveConfig();
    renderControls(config.controls);
    renderCostInputs(config.costs, currentBackend);
    renderRetailInputs(config.retails, currentBackend);
    runSimulation();
}

// --- DOM RENDERERS ---
function renderControls(controls) {
    const container = document.getElementById('config-container');
    container.innerHTML = `<div class="grid grid-cols-2 gap-4 w-full pt-2"></div>`;
    const grid = container.firstChild;
    
    controls.forEach(c => {
        const wrap = document.createElement('div');
        if(c.type === 'number') {
            wrap.innerHTML = `<label class="block text-[9px] font-bold text-gray-500 uppercase mb-1">${c.label}</label><input type="number" id="cfg-${c.id}" value="${c.def}" class="w-full border border-gray-300 p-1.5 rounded text-xs font-bold text-gray-700 bg-white outline-none" onchange="runSimulation()">`;
        } else if (c.type === 'select') {
            const opts = c.opts.map(o => `<option value="${o.v}">${o.t}</option>`).join('');
            wrap.className = "col-span-2";
            wrap.innerHTML = `<label class="block text-[9px] font-bold text-gray-500 uppercase mb-1">${c.label}</label><select id="cfg-${c.id}" class="w-full border border-gray-300 p-1.5 rounded text-xs font-bold bg-white text-gray-700 outline-none" onchange="runSimulation()">${opts}</select>`;
        } else if (c.type === 'toggle') {
            const checked = c.def ? 'checked' : '';
            wrap.className = "col-span-2 flex items-center justify-between bg-white border border-gray-200 p-2 rounded shadow-sm";
            wrap.innerHTML = `<span class="text-[10px] font-bold text-gray-600 uppercase">${c.label}</span><div class="relative inline-block w-8 align-middle select-none"><input type="checkbox" id="cfg-${c.id}" ${checked} class="toggle-checkbox absolute block w-4 h-4 rounded-full bg-white border-2 appearance-none cursor-pointer border-gray-300" onchange="runSimulation()"/><label for="cfg-${c.id}" class="toggle-label block overflow-hidden h-4 rounded-full bg-gray-300 cursor-pointer"></label></div>`;
        }
        grid.appendChild(wrap);
    });
}

function renderCostInputs(costs, data) {
    const container = document.getElementById('cost-container');
    container.innerHTML = `<div class="grid grid-cols-2 gap-3 w-full pt-2"></div>`;
    const grid = container.firstChild;
    if(!costs) return;
    
    let currentHeading = "";
    costs.forEach(c => {
        if(c.heading && c.heading !== currentHeading) {
            currentHeading = c.heading;
            const h = document.createElement('div');
            h.className = "col-span-2 text-[9px] font-black text-red-500 uppercase border-b border-red-100 pb-1 mt-2 tracking-widest";
            h.innerText = currentHeading;
            grid.appendChild(h);
        }
        
        let def = 0;
        if(c.key.includes("Attendance")) def = 1.0;
        const val = parseFloat(data[c.key]) || def;
        const div = document.createElement('div');
        div.innerHTML = `<label class="block text-[9px] font-bold text-red-700 uppercase mb-1 truncate" title="${c.key}">${c.label}</label><input type="number" id="cost-${c.key}" value="${val}" step="${c.key.includes('Ratio') ? '0.1' : '0.01'}" class="w-full border border-red-200 bg-white p-1.5 rounded text-xs font-bold text-red-900 focus:border-red-500 outline-none transition shadow-inner" onchange="runSimulation()">`;
        grid.appendChild(div);
    });
}

function renderRetailInputs(retails, data) {
    const container = document.getElementById('retail-container');
    container.innerHTML = `<div class="grid grid-cols-2 gap-3 w-full pt-2"></div>`;
    const grid = container.firstChild;
    if(!retails) return;
    
    let currentHeading = "";
    retails.forEach(r => {
        if(r.heading && r.heading !== currentHeading) {
            currentHeading = r.heading;
            const h = document.createElement('div');
            h.className = "col-span-2 text-[9px] font-black text-blue-500 uppercase border-b border-blue-100 pb-1 mt-2 tracking-widest";
            h.innerText = currentHeading;
            grid.appendChild(h);
        }
        
        const val = parseFloat(data[r.key]) || 0;
        const div = document.createElement('div');
        div.innerHTML = `<label class="block text-[9px] font-bold text-blue-800 uppercase mb-1 truncate" title="${r.key}">${r.label}</label><input type="number" id="ret-${r.key}" value="${val}" step="0.01" class="w-full border border-blue-200 bg-white p-1.5 rounded text-xs font-bold text-blue-900 focus:border-blue-500 outline-none transition shadow-inner" onchange="runSimulation()">`;
        grid.appendChild(div);
    });
}

// --- SIMULATION ENGINE ---
function runSimulation() {
    const config = getActiveConfig();
    const engine = config.engine;

    const start = parseInt(document.getElementById('range-start').value) || 1;
    const end = parseInt(document.getElementById('range-end').value) || 100;
    let step = parseInt(document.getElementById('range-step').value) || 1;
    if (step < 1) step = 1;

    let inputs = { qty: 1 };
    config.controls.forEach(c => {
        const el = document.getElementById(`cfg-${c.id}`);
        if(c.type === 'toggle') inputs[c.id] = el.checked;
        else if(c.type === 'number') inputs[c.id] = parseFloat(el.value);
        else if(c.type === 'select') inputs[c.id] = isNaN(Number(el.value)) ? el.value : Number(el.value);
    });

    if (typeof config.dynamicUI === 'function') inputs = config.dynamicUI(inputs);

    if(!inputs.files) inputs.files = 1;
    if(inputs.setupPerFile === undefined) inputs.setupPerFile = false;

    let simData = { ...currentBackend };
    if(config.costs) config.costs.forEach(c => simData[c.key] = parseFloat(document.getElementById(`cost-${c.key}`).value));
    if(config.retails) config.retails.forEach(r => simData[r.key] = parseFloat(document.getElementById(`ret-${r.key}`).value));

    simulationData = [];
    for (let q = start; q <= end; q += step) {
        inputs.qty = q;
        try {
            const result = engine(inputs, simData);
            simulationData.push({ qty: q, ...result });
        } catch (e) {
            console.error(`Simulation failed at qty ${q}:`, e);
        }
    }

    renderChart();
    if(simulationData.length > 0) renderReceipt(0); // Auto-load first item
}

function renderChart() {
    const ctx = document.getElementById('priceChart').getContext('2d');
    if (chartInstance) chartInstance.destroy();

    const labels = [];
    const costData = [];
    const retailData = [];
    const secondaryData = [];

    const isMargin = (currentViewMode === 'margin');

    simulationData.forEach(d => {
        labels.push(d.qty);
        
        const r = d.retail;
        const c = d.cost;
        const retailTotal = typeof r === 'number' ? r : (r?.grandTotal || r?.quoteTotal || r?.total || r?.printBase || 0);
        const costTotal = typeof c === 'number' ? c : (c?.grandTotal || c?.total || c?.quoteTotal || c?.printBase || 0);

        const uRet = retailTotal / d.qty;
        const uCost = costTotal / d.qty;
        
        costData.push(uCost);
        retailData.push(uRet);
        
        if (isMargin) {
            const margin = uRet > 0 ? ((uRet - uCost) / uRet) * 100 : 0;
            secondaryData.push(margin);
        } else {
            const profit = uRet - uCost;
            secondaryData.push(profit);
        }
    });

    chartInstance = new Chart(ctx, {
        data: {
            labels: labels,
            datasets: [
                { label: 'Unit Cost', data: costData, borderColor: '#ef4444', backgroundColor: '#fca5a5', type: 'line', tension: 0.1, yAxisID: 'y' },
                { label: 'Unit Retail', data: retailData, borderColor: '#3b82f6', backgroundColor: '#93c5fd', type: 'line', tension: 0.1, yAxisID: 'y' },
                {
                    label: isMargin ? 'Margin %' : 'Net Profit ($)',
                    data: secondaryData,
                    backgroundColor: isMargin ? 'rgba(250, 204, 21, 0.4)' : 'rgba(34, 197, 94, 0.4)',
                    borderColor: isMargin ? '#eab308' : '#16a34a',
                    borderWidth: 1,
                    type: 'bar',
                    yAxisID: 'y1'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            onClick: (event, elements, chart) => {
                if (elements.length > 0) {
                    renderReceipt(elements[0].index);
                } else {
                    // Fallback area click
                    const xValue = chart.scales.x.getValueForPixel(event.x);
                    if (xValue !== undefined) {
                        const closestIndex = Math.round(xValue);
                        if (closestIndex >= 0 && closestIndex < simulationData.length) {
                             renderReceipt(closestIndex);
                        }
                    }
                }
            },
            onHover: (event, chartElement) => {
                event.native.target.style.cursor = chartElement.length ? 'pointer' : 'default';
            },
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) label += ': ';
                            if (context.parsed.y !== null) {
                                if (context.datasetIndex === 2 && isMargin) label += context.parsed.y.toFixed(1) + '%';
                                else label += '$' + context.parsed.y.toFixed(2);
                            }
                            return label;
                        }
                    }
                }
            },
            scales: {
                y: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'Price / Cost ($)' }, grid: { color: '#f1f5f9' }, beginAtZero: true },
                y1: { 
                    type: 'linear', 
                    display: true, 
                    position: 'right', 
                    title: { display: true, text: isMargin ? 'Margin (%)' : 'Net Profit ($)' }, 
                    grid: { drawOnChartArea: false }, 
                    min: isMargin ? 0 : undefined, 
                    max: isMargin ? 100 : undefined 
                },
                x: { title: { display: true, text: 'Quantity' }, grid: { display: false } }
            }
        }
    });
}

function renderReceipt(index) {
    const data = simulationData[index];
    if (!data) return;

    document.getElementById('rec-qty').innerText = data.qty;
    const fmt = (n) => "$" + parseFloat(n || 0).toFixed(2);

    const config = getActiveConfig();
    const content = document.getElementById('rec-content');
    
    if (typeof config.renderReceipt === 'function') {
        content.innerHTML = config.renderReceipt(data, fmt);
    } else {
        content.innerHTML = `<div class="text-center text-red-500 font-bold mt-10">Receipt template not defined for this module.</div>`;
    }
    
    // Update Total Profit Bar
    const r = data.retail;
    const c = data.cost;
    const retailTotal = typeof r === 'number' ? r : (r?.grandTotal || r?.quoteTotal || r?.total || r?.printBase || 0);
    const costTotal = typeof c === 'number' ? c : (c?.grandTotal || c?.total || c?.quoteTotal || c?.printBase || 0);
    const net = retailTotal - costTotal;
    
    const profitBar = document.getElementById('rec-profit-bar');
    const profitVal = document.getElementById('rec-total-profit');
    
    profitBar.classList.remove('hidden');
    profitVal.innerText = fmt(net);
    profitVal.className = `text-xl font-black tracking-tight ${net < 0 ? 'text-red-500' : 'text-green-600'}`;
}

function exportData() {
    if(simulationData.length === 0) { alert("No data to export."); return; }

    const config = getActiveConfig();
    const modKey = document.getElementById('sim-module').options[document.getElementById('sim-module').selectedIndex].text;
    const rawKey = document.getElementById('sim-module').value;

    let out = `SIGNOS PRICING SIMULATION EXPORT\n`;
    out += `Module: ${modKey} (${config.tab})\n`;
    out += `Date: ${new Date().toLocaleString()}\n`;
    out += `========================================\n\n`;

    out += `--- ACTIVE VARIABLES ---\n\n`;
    out += `[RETAIL DRIVERS]\n`;
    if (config.retails) {
        config.retails.forEach(r => {
            const val = document.getElementById(`ret-${r.key}`).value;
            out += `${r.label.padEnd(25)} : ${val}\n`;
        });
    } else { out += `No overrides set.\n`; }

    out += `\n[COST DRIVERS]\n`;
    if (config.costs) {
        config.costs.forEach(c => {
            const val = document.getElementById(`cost-${c.key}`).value;
            out += `${c.label.padEnd(25)} : ${val}\n`;
        });
    }

    out += `\n========================================\n`;
    out += ` QTY  | RETAIL EA  | COST EA    | MARGIN % | NET PROFIT $\n`;
    out += `----------------------------------------------------------\n`;

    simulationData.forEach(d => {
        const r = d.retail;
        const c = d.cost;

        const retailTotal = typeof r === 'number' ? r : (r?.grandTotal || r?.quoteTotal || r?.total || r?.printBase || 0);
        const costTotal = typeof c === 'number' ? c : (c?.grandTotal || c?.total || c?.quoteTotal || c?.printBase || 0);

        const uRet = retailTotal / d.qty;
        const uCost = costTotal / d.qty;
        const margin = uRet > 0 ? ((uRet - uCost) / uRet) * 100 : 0;
        const profit = uRet - uCost;

        const qStr = d.qty.toString().padEnd(4);
        const rStr = `$${uRet.toFixed(2)}`.padEnd(10);
        const cStr = `$${uCost.toFixed(2)}`.padEnd(10);
        const mStr = `${margin.toFixed(1)}%`.padEnd(8);
        const pStr = `$${profit.toFixed(2)}`;

        out += ` ${qStr} | ${rStr} | ${cStr} | ${mStr} | ${pStr}\n`;
    });

    const blob = new Blob([out], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `SignOS_Sim_${rawKey}_${Date.now()}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}
</script>
</body>
</html>
