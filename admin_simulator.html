<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pricing Simulator v1.4</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="signos-core.js"></script>
    
    <!-- IMPORT LOGIC ENGINES -->
    <script src="logic_yard.js"></script>
    <script src="logic_acm.js"></script>

    <style>
        .chart-container { position: relative; height: 50vh; width: 100%; }
        input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .toggle-checkbox:checked { right: 0; border-color: #2563EB; }
        .toggle-checkbox:checked + .toggle-label { background-color: #2563EB; }
        
        /* Sandbox Inputs */
        .cost-input { @apply border-red-200 text-red-800 bg-red-50 focus:border-red-500 focus:bg-white; }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col font-sans overflow-hidden">

    <!-- HEADER -->
    <div id="main-card" class="flex-1 flex flex-col min-h-0 bg-white shadow-xl m-4 rounded-xl border border-gray-200 overflow-hidden">
        
        <!-- TOP TOOLBAR -->
        <div class="bg-white border-b border-gray-200 px-6 py-4 grid grid-cols-12 gap-4 shrink-0 items-end z-20 relative">
            <!-- MODULE -->
            <div class="col-span-3">
                <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Engine</label>
                <select id="sim-module" class="w-full border border-gray-300 rounded p-2 text-sm font-bold bg-white focus:border-blue-500 outline-none" onchange="loadModuleData()">
                    <option value="YARD">Yard Signs (Coro)</option>
                    <option value="ACM">ACM Signs (Metal)</option>
                </select>
            </div>

            <!-- RANGE -->
            <div class="col-span-6 flex gap-4">
                <div class="flex-1 bg-gray-50 p-2 rounded border border-gray-200">
                    <label class="block text-[9px] font-bold text-gray-400 uppercase mb-1">Simulation Range (Qty)</label>
                    <div class="flex items-center gap-2">
                        <input type="number" id="range-start" value="1" class="w-16 border rounded p-1 text-center text-sm font-bold" placeholder="Start">
                        <span class="text-gray-300 font-bold">-</span>
                        <input type="number" id="range-end" value="100" class="w-16 border rounded p-1 text-center text-sm font-bold" placeholder="End">
                        <span class="text-gray-400 text-[10px] uppercase font-bold ml-2">Step:</span>
                        <input type="number" id="range-step" value="5" class="w-12 border rounded p-1 text-center text-sm font-bold">
                    </div>
                </div>
            </div>

            <!-- ACTION -->
            <div class="col-span-3 text-right">
                <button onclick="runSimulation()" id="btn-run" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded shadow transition w-full disabled:opacity-50 disabled:cursor-not-allowed text-xs tracking-wider">
                    RE-CALCULATE
                </button>
            </div>
        </div>

        <!-- OPTIONS PANEL (Blue) -->
        <div class="bg-blue-50/50 border-b border-blue-100 px-6 py-3 shrink-0 overflow-x-auto relative z-10">
            <div class="flex items-center gap-6" id="config-container">
                <!-- Product Options Injected Here -->
            </div>
        </div>

        <!-- COST SANDBOX PANEL (Red) -->
        <div class="bg-red-50 border-b border-red-100 px-6 py-3 shrink-0 overflow-x-auto shadow-inner relative z-10">
            <div class="flex items-center gap-2 mb-2">
                <h3 class="text-[9px] font-black text-red-800 uppercase tracking-widest flex items-center gap-2">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg>
                    Backend Cost Drivers (Sandbox)
                </h3>
                <span class="text-[9px] text-red-400 font-medium ml-2">Changes here are temporary and do not save to database.</span>
            </div>
            <div class="flex items-center gap-4" id="cost-container">
                <!-- Cost Variables Injected Here -->
            </div>
        </div>

        <!-- CHART AREA -->
        <div class="flex-1 p-6 relative bg-white overflow-hidden">
            <div class="chart-container h-full w-full">
                <canvas id="priceChart"></canvas>
            </div>
            <div id="loader" class="absolute inset-0 flex items-center justify-center bg-white/80 z-50 hidden">
                <div class="text-center">
                    <div class="w-10 h-10 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-2"></div>
                    <span class="text-xs font-bold text-gray-400 tracking-widest">CRUNCHING DATA...</span>
                </div>
            </div>
        </div>

        <!-- STATS FOOTER -->
        <div class="bg-gray-900 text-white px-6 py-2 flex justify-between text-[10px] font-mono shrink-0 items-center">
            <div>
                <span class="text-gray-500">SOURCE:</span>
                <span id="data-source" class="text-blue-400 font-bold ml-2">---</span>
            </div>
            <div class="flex gap-6">
                <div class="flex items-center gap-2"><span class="w-3 h-3 bg-blue-600 rounded-sm"></span> RETAIL UNIT</div>
                <div class="flex items-center gap-2"><span class="w-3 h-3 bg-red-500 rounded-sm border border-red-400 border-dashed"></span> COST UNIT</div>
                <div class="flex items-center gap-2"><span class="w-3 h-3 bg-yellow-400 rounded-sm opacity-50"></span> MARGIN %</div>
            </div>
        </div>

    </div>

<script>
    let chartInstance = null;
    let currentBackend = {};
    
    // --- 1. MODULE DEFINITIONS ---
    const MODULES = {
        'YARD': { 
            tab: 'PROD_Yard_Signs', 
            engine: 'calculateYardSign',
            controls: [
                { id: 'sides', label: 'Print Sides', type: 'select', opts: [{v:1, t:'Single Sided'}, {v:2, t:'Double Sided'}] },
                { id: 'stakes', label: 'Wire Stakes', type: 'toggle', def: true },
                { id: 'files', label: 'Files', type: 'number', def: 1 },
                { id: 'incDesign', label: 'Design Fee', type: 'toggle', def: false },
                { id: 'setupPerFile', label: 'Setup / File', type: 'toggle', def: false }
            ],
            costs: [
                { key: 'Cost_Blank_Standard', label: 'Blank Cost ($)' },
                { key: 'Cost_Ink_Base', label: 'Ink / SqFt ($)' },
                { key: 'Rate_Operator', label: 'Labor / Hr ($)' },
                { key: 'Rate_Machine', label: 'Machine / Hr ($)' },
                { key: 'Time_Setup_Base', label: 'Setup Mins' },       // NEW
                { key: 'Labor_Attendance_Ratio', label: 'Attn Ratio (0-1)' } // NEW
            ]
        },
        'ACM': { 
            tab: 'PROD_ACM_Signs', 
            engine: 'calculateACM',
            controls: [
                { id: 'w', label: 'Width', type: 'number', def: 24 },
                { id: 'h', label: 'Height', type: 'number', def: 18 },
                { id: 'thickness', label: 'Material', type: 'select', opts: [{v:'3mm', t:'3mm Std'}, {v:'6mm', t:'6mm HD'}] },
                { id: 'sides', label: 'Sides', type: 'select', opts: [{v:1, t:'1-Sided'}, {v:2, t:'2-Sided'}] },
                { id: 'lam', label: 'Laminate', type: 'select', opts: [{v:'Gloss', t:'Gloss'}, {v:'Matte', t:'Matte'}] },
                { id: 'shape', label: 'Shape', type: 'select', opts: [{v:'Rectangle', t:'Rectangle'}, {v:'Contour', t:'Contour'}] },
                { id: 'incDesign', label: 'Design Fee', type: 'toggle', def: false }
            ],
            costs: [
                { key: 'Cost_Sheet_3mm', label: '3mm Sheet ($)' },
                { key: 'Rate_CNC_Labor', label: 'CNC Labor ($)' },
                { key: 'Time_Setup_Base', label: 'Setup Mins' },       // NEW
                { key: 'Labor_Attendance_Ratio', label: 'Attn Ratio (0-1)' } // NEW
            ]
        }
    };

    window.onload = function() {
        injectHeader("Pricing Simulator");
        loadModuleData();
    };

    // --- 2. LOAD DATA & RENDER UI ---
    async function loadModuleData() {
        const modKey = document.getElementById('sim-module').value;
        const config = MODULES[modKey];
        const btn = document.getElementById('btn-run');
        const statusText = document.getElementById("status-text");
        const statusDot = document.getElementById("status-dot");

        btn.innerText = "LOADING...";
        btn.disabled = true;

        renderControls(config.controls);
        document.getElementById('cost-container').innerHTML = `<span class="text-xs text-red-300 font-bold animate-pulse">Fetching backend data...</span>`;

        try {
            const u = sessionStorage.getItem('signos_user') || 'Admin';
            const res = await fetch(`${SCRIPT_URL}?req=view_module&tab=${config.tab}&user=${u}`);
            const data = await res.json();
            
            if(data.error) throw new Error(data.error);
            currentBackend = data;
            
            document.getElementById('data-source').innerText = `${config.tab} (${data.Sys_Version_Live || 'v?'})`;
            if(typeof window[config.engine] !== 'function') throw new Error(`Logic Engine '${config.engine}' missing.`);

            renderCostInputs(config.costs, data);

            btn.innerText = "RUN SIMULATION";
            btn.disabled = false;
            
            if(statusText) {
                statusText.innerText = "ONLINE";
                statusText.className = "font-bold text-green-500";
                statusDot.className = "w-2 h-2 rounded-full bg-green-500";
                statusDot.classList.remove("animate-pulse");
            }

            runSimulation();

        } catch(e) {
            alert("Load Error: " + e.message);
            btn.innerText = "ERROR";
            if(statusText) {
                statusText.innerText = "OFFLINE";
                statusText.className = "font-bold text-red-500";
            }
        }
    }

    function renderControls(controls) {
        const container = document.getElementById('config-container');
        container.innerHTML = "";

        controls.forEach(c => {
            const wrap = document.createElement('div');
            
            if(c.type === 'number') {
                wrap.innerHTML = `
                    <label class="block text-[9px] font-bold text-blue-800 uppercase mb-1">${c.label}</label>
                    <input type="number" id="cfg-${c.id}" value="${c.def}" class="w-20 border border-blue-200 p-1 rounded text-sm font-bold text-center text-blue-900 focus:border-blue-500 outline-none">
                `;
            } else if (c.type === 'select') {
                const opts = c.opts.map(o => `<option value="${o.v}">${o.t}</option>`).join('');
                wrap.innerHTML = `
                    <label class="block text-[9px] font-bold text-blue-800 uppercase mb-1">${c.label}</label>
                    <select id="cfg-${c.id}" class="border border-blue-200 p-1 rounded text-sm font-bold bg-white w-28 text-blue-900 focus:border-blue-500 outline-none">${opts}</select>
                `;
            } else if (c.type === 'toggle') {
                const checked = c.def ? 'checked' : '';
                wrap.innerHTML = `
                    <div class="flex items-center gap-2 mt-4">
                        <div class="relative inline-block w-8 align-middle select-none">
                            <input type="checkbox" id="cfg-${c.id}" ${checked} class="toggle-checkbox absolute block w-4 h-4 rounded-full bg-white border-4 appearance-none cursor-pointer border-gray-300"/>
                            <label for="cfg-${c.id}" class="toggle-label block overflow-hidden h-4 rounded-full bg-gray-300 cursor-pointer"></label>
                        </div>
                        <span class="text-[10px] font-bold text-blue-800 uppercase">${c.label}</span>
                    </div>
                `;
            }
            container.appendChild(wrap);
        });
    }

    function renderCostInputs(costs, data) {
        const container = document.getElementById('cost-container');
        container.innerHTML = "";

        costs.forEach(c => {
            // Get value from backend, default to 0 if missing. 
            // Default Attendance to 1.0 if missing (100% attention)
            let def = 0;
            if(c.key.includes("Attendance")) def = 1.0; 
            const val = parseFloat(data[c.key]) || def;

            const div = document.createElement('div');
            div.innerHTML = `
                <label class="block text-[9px] font-bold text-red-700 uppercase mb-1 truncate" title="${c.key}">${c.label}</label>
                <input type="number" id="cost-${c.key}" value="${val}" step="${c.key.includes('Ratio') ? '0.1' : '0.01'}" 
                    class="w-24 border border-red-200 bg-red-50 p-1 rounded text-sm font-bold text-center text-red-900 focus:border-red-500 focus:bg-white outline-none transition"
                    onchange="runSimulation()">
            `;
            container.appendChild(div);
        });
    }

    // --- 3. SIMULATION ENGINE ---
    function runSimulation() {
        const modKey = document.getElementById('sim-module').value;
        const config = MODULES[modKey];
        const engine = window[config.engine];

        const start = parseInt(document.getElementById('range-start').value);
        const end = parseInt(document.getElementById('range-end').value);
        const step = parseInt(document.getElementById('range-step').value);

        let inputs = { qty: 1 };
        config.controls.forEach(c => {
            const el = document.getElementById(`cfg-${c.id}`);
            if(c.type === 'toggle') inputs[c.id] = el.checked;
            else if(c.type === 'number') inputs[c.id] = parseFloat(el.value);
            else if(c.type === 'select') inputs[c.id] = isNaN(parseFloat(el.value)) ? el.value : parseFloat(el.value);
        });
        if(!inputs.files) inputs.files = 1;
        if(!inputs.rounded) inputs.rounded = false; 

        // SANDBOX DATA INJECTION
        let simBackend = { ...currentBackend };
        config.costs.forEach(c => {
            const el = document.getElementById(`cost-${c.key}`);
            if(el) {
                simBackend[c.key] = parseFloat(el.value);
            }
        });

        const labels = [];
        const retailPoints = [];
        const costPoints = [];
        const marginPoints = [];

        for (let q = start; q <= end; q += step) {
            labels.push(q);
            inputs.qty = q; 

            const result = engine(inputs, simBackend);
            
            const unitRetail = result.retail.grandTotal / q;
            const unitCost = result.cost.total / q;
            const margin = ((unitRetail - unitCost) / unitRetail) * 100;

            retailPoints.push(unitRetail.toFixed(2));
            costPoints.push(unitCost.toFixed(2));
            marginPoints.push(margin.toFixed(1));
        }

        renderChart(labels, retailPoints, costPoints, marginPoints);
    }

    function renderChart(labels, retail, cost, margin) {
        const ctx = document.getElementById('priceChart').getContext('2d');
        if(chartInstance) chartInstance.destroy();

        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Unit Retail ($)',
                        data: retail,
                        borderColor: '#2563eb', 
                        backgroundColor: '#2563eb',
                        yAxisID: 'y',
                        tension: 0.1,
                        borderWidth: 3
                    },
                    {
                        label: 'Unit Cost ($)',
                        data: cost,
                        borderColor: '#ef4444', 
                        backgroundColor: '#ef4444',
                        yAxisID: 'y',
                        borderDash: [1],
                        borderWidth: 2
                    },
                    {
                        label: 'Margin %',
                        data: margin,
                        borderColor: '#fbbf24', 
                        backgroundColor: 'rgba(251, 191, 36, 0.5)',
                        yAxisID: 'y1',
                        type: 'bar',
                        barThickness: 'flex',
                        maxBarThickness: 40,
                        opacity: 0.5
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                scales: {
                    y: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'Price / Cost ($)' }, grid: { color: '#f3f4f6' } },
                    y1: { type: 'linear', display: true, position: 'right', title: { display: true, text: 'Margin (%)' }, grid: { drawOnChartArea: false }, min: 0, max: 100 },
                    x: { title: { display: true, text: 'Quantity' }, grid: { display: false } }
                }
            }
        });
    }
</script>
</body>
</html>
