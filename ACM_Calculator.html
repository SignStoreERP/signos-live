<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ACM Signs v6.12 (Sandbox)</title>
    
    <script>
        if(!sessionStorage.getItem('signos_user')) {
            sessionStorage.setItem('signos_user', 'TEST_MODE');
            sessionStorage.setItem('signos_role', 'ADMIN');
            console.warn("‚ö†Ô∏è Sandbox Mode: Auto-Authentication Active");
        }
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="signos-core.js"></script>
    <script src="logic_acm.js"></script>
    
    <style>
        .warn-pulse { animation: pulse-red 2s infinite; }
        @keyframes pulse-red { 0% { background-color: #FECACA; } 50% { background-color: #F87171; } 100% { background-color: #FECACA; } }
        .toggle-checkbox:checked { right: 0; border-color: #2563EB; }
        .toggle-checkbox:checked + .toggle-label { background-color: #2563EB; }
        
        .svg-preview { display: flex; align-items: center; justify-content: center; background: transparent; }
        .svg-preview svg { width: 100%; height: 100%; max-height: 100%; display: block; object-fit: contain; }

        .grid-bg {
            background-color: #f8fafc;
            background-image: 
                linear-gradient(to right, #e2e8f0 1px, transparent 1px),
                linear-gradient(to bottom, #e2e8f0 1px, transparent 1px);
            background-size: 40px 40px;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans">

    <div id="main-card" class="max-w-md mx-auto w-full bg-white shadow-2xl overflow-hidden min-h-screen sm:min-h-0 sm:my-10 sm:rounded-xl border border-gray-200">

        <div class="bg-gray-800 px-4 py-1 flex justify-between items-center text-[10px] text-gray-400 border-b border-gray-700">
            <div class="flex gap-2">
                <span>USER: <b id="auth-user" class="text-gray-200">Loading...</b></span>
                <span>ROLE: <b id="auth-role" class="text-gray-200">---</b></span>
            </div>
            <button onclick="logout()" class="hover:text-white font-bold uppercase transition flex items-center gap-1">
                Logout
            </button>
        </div>

        <div class="bg-gray-900 px-6 py-4 text-white flex justify-between items-center">
            <a href="#" onclick="goBack()" class="text-gray-400 hover:text-white text-xs font-bold uppercase flex items-center gap-1">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15 19l-7-7 7-7"/></svg> MENU
            </a>
            <div class="text-center">
                <h2 class="text-lg font-bold">ACM Signs</h2>
                <div class="flex items-center justify-center gap-2 text-[10px] mt-0.5">
                    <span id="status-dot" class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span>
                    <span id="status-text" class="font-bold text-gray-400">CONNECTING...</span>
                    <span id="version-display" class="text-gray-500 font-mono hidden"></span>
                </div>
            </div>
            <button onclick="location.reload()" class="text-gray-400 hover:text-white"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg></button>
        </div>

        <div id="size-warn" class="hidden bg-orange-500 text-white text-center py-2 px-4 text-xs font-bold uppercase tracking-wide animate-pulse">
            ‚ö†Ô∏è Oversized: Exceeds 60" x 120"
        </div>

        <div class="p-6 space-y-4">
            <div class="grid grid-cols-3 gap-3">
                <div><label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Qty</label><input type="number" id="qty" value="1" min="1" class="w-full border p-2 rounded font-bold text-gray-800 text-lg text-center" oninput="validateInput(this)" onblur="validateInput(this)"></div>
                <div><label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Width</label><input type="number" id="width" value="24" min="1" class="w-full border p-2 rounded font-bold text-gray-800 text-lg text-center" oninput="validateInput(this)" onblur="validateInput(this)"></div>
                <div><label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Height</label><input type="number" id="height" value="18" min="1" class="w-full border p-2 rounded font-bold text-gray-800 text-lg text-center" oninput="validateInput(this)" onblur="validateInput(this)"></div>
            </div>

            <div class="bg-blue-50 p-3 rounded border border-blue-100 space-y-3">
                <div class="flex items-center gap-3">
                    <div class="w-1/3">
                        <label class="block text-[9px] font-bold text-blue-800 uppercase mb-1"># Designs</label>
                        <input type="number" id="files" value="1" min="1" class="w-full border border-blue-200 p-1.5 rounded font-bold text-center text-sm" oninput="validateInput(this)" onblur="validateInput(this)">
                    </div>
                    <div class="flex-1 space-y-2">
                        <div class="flex items-center justify-between">
                            <span class="text-[10px] font-bold text-gray-600">Charge setup per file?</span>
                            <input type="checkbox" id="setup-per-file" class="w-4 h-4 text-blue-600" onchange="runCalc()">
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-[10px] font-bold text-purple-700">Include design fee?</span>
                            <input type="checkbox" id="design" class="w-4 h-4 text-purple-600" onchange="updateDesignOptions()">
                        </div>
                    </div>
                </div>
                <div id="sub-design-opt" class="hidden border-t border-blue-200 pt-2 flex items-center justify-end gap-2">
                    <span class="text-[9px] font-bold text-gray-500 uppercase tracking-wide">Charge design per file?</span>
                    <input type="checkbox" id="design-per-file" class="w-4 h-4 text-purple-600" onchange="runCalc()">
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Material</label><select id="material" class="w-full border p-2 rounded bg-white font-bold text-sm" onchange="runCalc()"><option value="3mm">3mm Standard</option><option value="6mm">6mm Heavy Duty</option></select></div>
                <div><label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Print Sides</label><select id="sides" class="w-full border p-2 rounded bg-white font-bold text-sm" onchange="runCalc()"><option value="1">Single Sided</option><option value="2">Double Sided</option></select></div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Laminate</label>
                    <select id="lam" class="w-full border p-2 rounded bg-white font-bold text-sm" onchange="runCalc()">
                        <option value="Gloss">Gloss (Default)</option>
                        <option value="Matte">Matte</option>
                    </select>
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Shape</label>
                    <select id="shape" class="w-full border p-2 rounded bg-white font-bold text-sm" onchange="updateShapeOptions()">
                        <option value="Rectangle">Rectangle / Square</option>
                        <option value="Contour">CNC Custom Shape</option>
                    </select>
                    <div id="sub-shape-opt" class="mt-2 flex items-center gap-2">
                        <input type="checkbox" id="rounded" class="w-4 h-4 text-blue-600" onchange="runCalc()">
                        <span class="text-[10px] font-bold text-gray-600">Rounded Corners?</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white p-6 border-t border-gray-200">
            <div class="flex justify-between items-center mb-4">
                <span class="text-xs font-bold text-gray-400 uppercase tracking-wide">Base Unit Price</span>
                <span class="text-2xl font-bold text-gray-900" id="ui-unit">---</span>
            </div>

            <div class="space-y-1 text-xs text-gray-600 border-t border-dashed border-gray-200 pt-2">
                <div class="flex justify-between"><span>Base Material & Print:</span><span id="li-mat" class="font-bold font-mono">$0.00</span></div>
                <div class="flex justify-between"><span>Laminate:</span><span id="li-lam" class="font-bold font-mono">$0.00</span></div>
                <div class="flex justify-between hidden" id="row-finish"><span>Finishing (<span id="lbl-finish">Shear</span>):</span><span id="li-finish" class="font-bold font-mono">$0.00</span></div>
                <div class="border-b border-gray-100 my-1"></div>
                <div class="flex justify-between text-blue-700"><span>Setup (<span id="lbl-setup">Flat</span>):</span><span id="ui-setup" class="font-bold">$0.00</span></div>
                <div class="flex justify-between text-purple-700 hidden" id="row-design"><span>Design (<span id="lbl-design">Flat</span>):</span><span id="ui-design" class="font-bold">$0.00</span></div>
            </div>

            <div class="flex justify-between items-end border-t-2 border-gray-800 my-4 pt-3">
                <div>
                    <span class="text-xs font-bold text-gray-400 uppercase">Total Quote</span>
                    <div id="min-badge" class="hidden bg-red-100 text-red-600 text-[9px] font-bold px-1 rounded inline-block ml-1">MINIMUM APPLIED</div>
                </div>
                <span class="text-3xl font-black text-blue-600" id="ui-total">---</span>
            </div>

            <button onclick="openLightbox()" id="opt-badge" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-600 text-[10px] font-bold px-3 py-2 rounded border border-gray-200 text-center hidden flex items-center justify-center gap-2 transition">
                <span>üìê Using <span id="opt-stock" class="text-blue-600">4x8</span> Stock</span>
                <svg class="w-3 h-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>

            <div id="nest-container" class="hidden mt-2 border-2 border-blue-500 rounded bg-gray-100 p-2 relative group cursor-zoom-in" onclick="openLightbox()">
                <div class="absolute top-2 right-2 bg-blue-600 text-white text-[9px] font-bold px-2 py-1 rounded shadow opacity-0 group-hover:opacity-100 transition">CLICK TO ZOOM</div>
                <div id="nest-svg" class="svg-preview h-32"></div>
                <div class="text-[9px] text-center text-gray-500 mt-1 font-mono">Blue: Cut Lines | Gray: Sheet</div>
            </div>
        </div>

        <div class="bg-gray-50 p-4 border-t border-gray-200">
            <label class="block text-[10px] font-bold text-gray-400 uppercase mb-2">Job Description</label>
            <textarea id="job-desc" class="w-full text-xs p-2 border rounded bg-white h-20 text-gray-600 font-mono outline-none" readonly></textarea>
        </div>

    </div>

    
    <div id="lightbox" class="fixed inset-0 z-50 hidden bg-black/90 flex items-center justify-center p-4">
        <div class="max-w-4xl w-full bg-white rounded-lg overflow-hidden shadow-2xl flex flex-col h-[90vh] md:h-[80vh]">
            
            <div class="bg-gray-900 text-white px-4 py-3 flex justify-between items-center shrink-0">
                <h3 class="font-bold text-sm flex items-center gap-2">
                    <span class="text-blue-400">üìê</span> Sheet Optimization Sandbox
                </h3>
                <button onclick="closeLightbox()" class="text-gray-400 hover:text-white font-bold text-lg">‚úï</button>
            </div>

            <div class="bg-gray-100 border-b border-gray-200 p-4 grid grid-cols-3 gap-4 shrink-0">
                <div>
                    <label class="block text-[9px] font-bold text-gray-500 uppercase">Quantity</label>
                    <input type="number" id="sim-qty" min="1" class="w-full border p-1 rounded text-sm font-bold text-center" oninput="validateInput(this); updateSim()">
                </div>
                <div>
                    <label class="block text-[9px] font-bold text-gray-500 uppercase">Width</label>
                    <input type="number" id="sim-w" min="1" class="w-full border p-1 rounded text-sm font-bold text-center" oninput="validateInput(this); updateSim()">
                </div>
                <div>
                    <label class="block text-[9px] font-bold text-gray-500 uppercase">Height</label>
                    <input type="number" id="sim-h" min="1" class="w-full border p-1 rounded text-sm font-bold text-center" oninput="validateInput(this); updateSim()">
                </div>
            </div>

            <div class="flex-1 grid-bg p-8 flex justify-center items-center overflow-hidden">
                <div id="lightbox-svg" class="w-full h-full max-w-3xl svg-preview drop-shadow-xl"></div>
            </div>

            <div class="p-3 bg-gray-900 border-t border-gray-800 text-white flex flex-wrap justify-between items-center text-[10px] sm:text-xs font-mono shrink-0 gap-4">
                <div class="flex items-center gap-2">
                    <span class="text-gray-500">STOCK:</span>
                    <span id="sim-stock" class="text-blue-400 font-bold text-sm tracking-wide">---</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-gray-500">INV:</span>
                    <span id="sim-inv" class="text-gray-400">---</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-gray-500">WASTE:</span>
                    <span id="sim-waste" class="text-red-400 font-bold">---%</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        let backendData = {};
        let currentSVG = "";

        // --- 1. VALIDATION & UI LOGIC ---
        function validateInput(el) {
            if (!el.value || parseFloat(el.value) <= 0) {
                el.value = 1;
            }
            if(el.id.includes('sim')) updateSim();
            else runCalc();
        }

        function toggleNesting() {
            document.getElementById('nest-container').classList.toggle('hidden');
        }

        function updateShapeOptions() {
            const shape = document.getElementById('shape').value;
            const subOpt = document.getElementById('sub-shape-opt');
            if(shape === 'Rectangle') {
                subOpt.classList.remove('hidden');
            } else {
                subOpt.classList.add('hidden');
                document.getElementById('rounded').checked = false;
            }
            runCalc();
        }

        function updateDesignOptions() {
            const incDesign = document.getElementById('design').checked;
            const subOpt = document.getElementById('sub-design-opt');
            if(incDesign) subOpt.classList.remove('hidden');
            else {
                subOpt.classList.add('hidden');
                document.getElementById('design-per-file').checked = false;
            }
            runCalc();
        }

        // --- 2. LIGHTBOX & SANDBOX ---
        function openLightbox() {
            document.getElementById('sim-qty').value = document.getElementById('qty').value;
            document.getElementById('sim-w').value = document.getElementById('width').value;
            document.getElementById('sim-h').value = document.getElementById('height').value;
            
            updateSim();
            document.getElementById('lightbox').classList.remove('hidden');
        }

        function closeLightbox() {
            document.getElementById('lightbox').classList.add('hidden');
        }

        function updateSim() {
            const simInputs = {
                qty: parseFloat(document.getElementById('sim-qty').value) || 1,
                w: parseFloat(document.getElementById('sim-w').value) || 24,
                h: parseFloat(document.getElementById('sim-h').value) || 18,
                thickness: document.getElementById('material').value,
                sides: 1, lam: "None", shape: "Square", incDesign: false, setupPerFile: false, files: 1
            };

            const res = calculateACM(simInputs, backendData);
            const stock = res.cost.stock;
            
            // Inject SVG Logic
            document.getElementById('lightbox-svg').innerHTML = stock.svg;

            // Updated Footer Logic (v6.12)
            if(stock.stats) {
                // Use the new pre-formatted string from Logic v2.9.2
                document.getElementById('sim-stock').innerText = stock.stats.formattedStock;
                document.getElementById('sim-inv').innerText = `${stock.stats.full} FULL / ${stock.stats.partial} OPEN`;
                document.getElementById('sim-waste').innerText = `${stock.stats.waste}%`;
            } else {
                document.getElementById('sim-stock').innerText = "N/A";
                document.getElementById('sim-inv').innerText = "---";
                document.getElementById('sim-waste').innerText = "---%";
            }
        }

        // --- 3. INITIALIZATION ---
        window.onload = async function() {
            const u = sessionStorage.getItem('signos_user') || 'Guest';
            const r = sessionStorage.getItem('signos_role') || 'VIEW';
            if(document.getElementById('auth-user')) document.getElementById('auth-user').innerText = u;
            if(document.getElementById('auth-role')) document.getElementById('auth-role').innerText = r;

            const timeout = new Promise((_, reject) => setTimeout(() => reject(new Error("Request Timed Out")), 5000));

            try {
                if (typeof calculateACM === 'undefined') throw new Error("Logic File Missing");
                
                const fetchPromise = fetch(`${SCRIPT_URL}?tab=PROD_ACM_Signs&ip=${clientIP}&user=${u}&role=${r}&req=view_module`);
                const res = await Promise.race([fetchPromise, timeout]);
                const data = await res.json();
                if(data.error) throw new Error(data.error);
                backendData = data;

                document.getElementById("status-text").innerText = "ONLINE";
                document.getElementById("status-text").className = "font-bold text-green-500";
                document.getElementById("status-dot").className = "w-2 h-2 rounded-full bg-green-500";
                document.getElementById("status-dot").classList.remove("animate-pulse");

                const isDev = window.location.href.includes('mode=dev');
                const ver = isDev ? (data.Sys_Version_Dev || 'v6.12') : (data.Sys_Version_Live || 'v6.12');
                if(document.getElementById("version-display")) {
                    document.getElementById("version-display").innerText = isDev ? `(Beta ${ver})` : `Live ${ver}`;
                    document.getElementById("version-display").classList.remove('hidden');
                }

                updateShapeOptions();
                runCalc();

            } catch(e) {
                console.error("Critical Error:", e);
                const statusText = document.getElementById("status-text");
                if(statusText) {
                    statusText.innerText = "OFFLINE";
                    statusText.className = "font-bold text-red-500";
                }
                alert("System Error: " + e.message);
            }
        };

        // --- 4. CALCULATION ENGINE ---
        function runCalc() {
            if(!backendData.Item_Name) return;

            const inputs = {
                w: parseFloat(document.getElementById('width').value) || 24,
                h: parseFloat(document.getElementById('height').value) || 18,
                qty: parseFloat(document.getElementById('qty').value) || 1,
                thickness: document.getElementById('material').value,
                sides: parseInt(document.getElementById('sides').value),
                lam: document.getElementById('lam').value,
                shape: document.getElementById('shape').value,
                rounded: document.getElementById('rounded').checked,
                incDesign: document.getElementById('design').checked,
                setupPerFile: document.getElementById('setup-per-file').checked,
                designPerFile: document.getElementById('design-per-file').checked,
                files: parseFloat(document.getElementById('files').value) || 1
            };

            const result = calculateACM(inputs, backendData);
            const ret = result.retail;
            const cost = result.cost;

            const warn = document.getElementById('size-warn');
            if(ret.isOversized) warn.classList.remove('hidden'); else warn.classList.add('hidden');

            const fmt = (n) => "$" + n.toFixed(2);

            document.getElementById('ui-unit').innerText = ret.isOversized ? "CUSTOM" : fmt(ret.unitPrice);
            document.getElementById('ui-total').innerText = ret.isOversized ? "CONTACT US" : fmt(ret.grandTotal);

            document.getElementById('li-mat').innerText = fmt(ret.breakdown.material);
            document.getElementById('li-lam').innerText = fmt(ret.breakdown.laminate);

            const finishVal = ret.breakdown.finish;
            const rowFinish = document.getElementById('row-finish');
            if(finishVal > 0) {
                rowFinish.classList.remove('hidden');
                document.getElementById('li-finish').innerText = fmt(finishVal);
                document.getElementById('lbl-finish').innerText = inputs.shape === 'Contour' ? 'CNC Shape' : 'Rounded Corners';
            } else {
                rowFinish.classList.add('hidden');
            }

            document.getElementById('ui-setup').innerText = fmt(ret.fees.setup);
            document.getElementById('lbl-setup').innerText = inputs.setupPerFile ? `${inputs.files} Files` : 'Flat';

            const rowDesign = document.getElementById('row-design');
            if(ret.fees.design > 0) {
                rowDesign.classList.remove('hidden');
                document.getElementById('ui-design').innerText = fmt(ret.fees.design);
                document.getElementById('lbl-design').innerText = inputs.designPerFile ? `${inputs.files} Files` : 'Flat';
            } else {
                rowDesign.classList.add('hidden');
            }

            document.getElementById('min-badge').classList.toggle('hidden', !ret.isMinApplied);

            const badge = document.getElementById('opt-badge');
            if (cost.stock && cost.stock.name !== "N/A" && !ret.isOversized) {
                badge.classList.remove('hidden');
                document.getElementById('opt-stock').innerText = `${cost.stock.name} (${cost.stock.sheets} shts)`;
                
                // Inject Main View SVG
                currentSVG = cost.stock.svg;
                document.getElementById('nest-svg').innerHTML = currentSVG;
            } else {
                badge.classList.add('hidden');
                document.getElementById('nest-container').classList.add('hidden');
            }

            const cutTxt = inputs.shape === 'Contour' ? 'CNC Custom Shape' : (inputs.rounded ? 'Shear Cut with Rounded Corners' : 'Shear Cut');
            const desc = `(x${inputs.qty}) ${inputs.w}" x ${inputs.h}" ${inputs.thickness} ACM Signs, ${inputs.lam} Laminated, ${cutTxt}.\nPrinted full color on ${inputs.sides === 1 ? "ONE side" : "TWO sides"}.`;
            document.getElementById('job-desc').value = desc;
        }
    </script>
</body>
</html>
