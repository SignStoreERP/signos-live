<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dev Roadmap v2.7 | SignOS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="signos-core.js"></script>
    
    <!-- 1. STANDARD CSS (Immediate Load) -->
    <style>
        .kanban-col { height: 100%; overflow-y: auto; padding-right: 4px; }
        .kanban-col::-webkit-scrollbar { width: 6px; }
        .kanban-col::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        .kanban-col::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .kanban-col::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Drag Visuals */
        .card-high { border-left: 4px solid #ef4444; }
        .card-med { border-left: 4px solid #f59e0b; }
        .card-low { border-left: 4px solid #3b82f6; }
        .drop-active { background-color: #e0f2fe !important; border: 2px dashed #3b82f6 !important; }
        
        .slide-panel { transition: transform 0.3s ease-in-out; }
        .slide-panel.closed { transform: translateX(100%); }
        .modal { transition: opacity 0.25s ease; }
        body.modal-active { overflow: hidden; }
        
        /* Timeline Line */
        .timeline-line::before { content: ''; position: absolute; left: 19px; top: 30px; bottom: -10px; width: 2px; background: #e5e7eb; z-index: 0; }
        .timeline-item:last-child .timeline-line::before { display: none; }
    </style>

    <!-- 2. TAILWIND COMPONENT CSS (Processed by Script) -->
    <style type="text/tailwindcss">
        .filter-chip { 
            @apply px-3 py-1 rounded-full text-[10px] font-bold border transition-all duration-200 uppercase tracking-wide cursor-pointer select-none flex items-center justify-center; 
        }
        
        .chip-user { @apply bg-white border-gray-300 text-gray-500 hover:bg-gray-50 hover:border-gray-400; }
        .chip-user.active { @apply bg-gray-800 border-gray-800 text-white shadow-md transform scale-105; }

        .chip-feat { @apply bg-blue-50 border-blue-200 text-blue-600 hover:bg-blue-100; }
        .chip-feat.active { @apply bg-blue-600 border-blue-600 text-white shadow-md; }

        .chip-bug { @apply bg-red-50 border-red-200 text-red-600 hover:bg-red-100; }
        .chip-bug.active { @apply bg-red-600 border-red-600 text-white shadow-md; }

        .chip-goal { @apply bg-purple-50 border-purple-200 text-purple-600 hover:bg-purple-100; }
        .chip-goal.active { @apply bg-purple-600 border-purple-600 text-white shadow-md; }

        .chip-high { @apply bg-red-50 border-red-200 text-red-600 hover:bg-red-100; }
        .chip-high.active { @apply bg-red-500 border-red-500 text-white shadow-md; }

        .chip-med { @apply bg-orange-50 border-orange-200 text-orange-600 hover:bg-orange-100; }
        .chip-med.active { @apply bg-orange-500 border-orange-500 text-white shadow-md; }

        .chip-low { @apply bg-blue-50 border-blue-200 text-blue-600 hover:bg-blue-100; }
        .chip-low.active { @apply bg-blue-400 border-blue-400 text-white shadow-md; }

        .draggable-card { @apply cursor-grab; }
        .draggable-card:active { @apply cursor-grabbing; }
        .draggable-card.dragging { @apply opacity-50 scale-95; }
    </style>
</head>
<body class="bg-gray-100 h-screen font-sans flex flex-col overflow-hidden">

    <!-- HEADER -->
    <div class="bg-gray-900 text-white px-6 py-3 flex justify-between items-center shadow-md z-30 shrink-0">
        <div class="flex items-center gap-3">
            <h1 class="text-lg font-black tracking-tight">SignOS Roadmap</h1>
            <span class="bg-purple-600 text-[10px] font-bold px-2 py-0.5 rounded text-white">LIVE TRACKER</span>
        </div>
        <div class="flex gap-4 text-xs font-bold items-center">
            <!-- NEW: History Button -->
            <button onclick="toggleChangelog()" class="bg-gray-700 hover:bg-gray-600 text-white px-3 py-1 rounded transition flex items-center gap-1 border border-gray-500 shadow-lg">
                <span>ðŸ“œ System History</span>
            </button>
            <span class="text-gray-600">|</span>
            <button onclick="toggleForm()" class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-1 rounded transition flex items-center gap-1 shadow-lg border border-blue-400"><span>+ New Item</span></button>
            <span class="text-gray-600">|</span>
            <a href="#" onclick="goBack()" class="text-gray-300 hover:text-white uppercase">Exit</a>
        </div>
    </div>

    <!-- FILTER BAR -->
    <div class="bg-white border-b border-gray-200 px-4 py-3 shadow-sm z-20 shrink-0 flex flex-col gap-3">
        <div class="flex items-center gap-4">
            <div class="relative flex-1 max-w-md">
                <svg class="w-4 h-4 absolute left-3 top-2.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                <input type="text" id="filter-search" placeholder="Search by title, description, or ID..." class="w-full border border-gray-300 pl-9 pr-3 py-1.5 rounded-lg text-sm bg-gray-50 focus:bg-white focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none transition" onkeyup="applyFilters()">
            </div>
            <div class="flex items-center gap-2 bg-gray-50 border border-gray-200 px-3 py-1 rounded-lg">
                <span class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Timeframe</span>
                <input type="date" id="date-start" class="bg-transparent text-xs font-bold text-gray-700 outline-none cursor-pointer" onchange="applyFilters()">
                <span class="text-gray-300">â†’</span>
                <input type="date" id="date-end" class="bg-transparent text-xs font-bold text-gray-700 outline-none cursor-pointer" onchange="applyFilters()">
            </div>
            <div class="flex-1 text-right">
                <button onclick="resetFilters()" class="text-[10px] text-gray-400 hover:text-red-500 font-bold uppercase tracking-wide transition">Reset All Filters âœ•</button>
            </div>
        </div>
        <div class="flex items-center gap-6 overflow-x-auto pb-1 no-scrollbar">
            <div class="flex items-center gap-2 shrink-0"><span class="text-[9px] font-black text-gray-300 uppercase tracking-widest">TEAM</span><div id="filter-users" class="flex gap-1"><span class="text-xs text-gray-400 italic px-2">Loading...</span></div></div>
            <div class="w-px h-6 bg-gray-200 shrink-0"></div>
            <div class="flex items-center gap-2 shrink-0">
                <span class="text-[9px] font-black text-gray-300 uppercase tracking-widest">TYPE</span>
                <div class="flex gap-1">
                    <button class="filter-chip chip-feat" onclick="toggleFilter('cat', 'Feature', this)">Feature</button>
                    <button class="filter-chip chip-bug" onclick="toggleFilter('cat', 'Bug', this)">Bug</button>
                    <button class="filter-chip chip-goal" onclick="toggleFilter('cat', 'Goal', this)">Goal</button>
                </div>
            </div>
            <div class="w-px h-6 bg-gray-200 shrink-0"></div>
            <div class="flex items-center gap-2 shrink-0">
                <span class="text-[9px] font-black text-gray-300 uppercase tracking-widest">PRIO</span>
                <div class="flex gap-1">
                    <button class="filter-chip chip-high" onclick="toggleFilter('prio', 'High', this)">High</button>
                    <button class="filter-chip chip-med" onclick="toggleFilter('prio', 'Med', this)">Med</button>
                    <button class="filter-chip chip-low" onclick="toggleFilter('prio', 'Low', this)">Low</button>
                </div>
            </div>
        </div>
    </div>

    <!-- KANBAN BOARD -->
    <div class="flex-1 overflow-x-auto overflow-y-hidden p-6 bg-gray-100">
        <div class="flex gap-6 h-full min-w-[1000px]">
            <div class="flex-1 flex flex-col bg-gray-200 rounded-xl border border-gray-300 shadow-sm" ondragover="allowDrop(event)" ondrop="drop(event, 'Pending')" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)">
                <div class="p-3 border-b border-gray-300 font-bold text-gray-600 text-xs uppercase tracking-wider flex justify-between shrink-0 bg-gray-200 rounded-t-xl z-10"><span>Backlog / Pending</span><span id="count-pending" class="bg-gray-300 px-2 rounded-full text-gray-700">0</span></div>
                <div id="col-pending" class="kanban-col p-3 space-y-3"></div>
            </div>
            <div class="flex-1 flex flex-col bg-blue-50 rounded-xl border border-blue-200 shadow-sm" ondragover="allowDrop(event)" ondrop="drop(event, 'In Progress')" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)">
                <div class="p-3 border-b border-blue-200 font-bold text-blue-800 text-xs uppercase tracking-wider flex justify-between shrink-0 bg-blue-50 rounded-t-xl z-10"><span>In Development</span><span id="count-progress" class="bg-blue-200 px-2 rounded-full text-blue-800">0</span></div>
                <div id="col-progress" class="kanban-col p-3 space-y-3"></div>
            </div>
            <div class="flex-1 flex flex-col bg-green-50 rounded-xl border border-green-200 shadow-sm" ondragover="allowDrop(event)" ondrop="drop(event, 'Complete')" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)">
                <div class="p-3 border-b border-green-200 font-bold text-green-800 text-xs uppercase tracking-wider flex justify-between shrink-0 bg-green-50 rounded-t-xl z-10"><span>Completed / Live</span><span id="count-done" class="bg-green-200 px-2 rounded-full text-green-800">0</span></div>
                <div id="col-done" class="kanban-col p-3 space-y-3"></div>
            </div>
        </div>
    </div>

    <!-- SIDE FORM -->
    <div id="side-form" class="fixed inset-y-0 right-0 w-96 bg-white shadow-2xl border-l border-gray-200 z-30 slide-panel closed flex flex-col">
        <div class="p-6 bg-gray-900 text-white flex justify-between items-center shrink-0"><h2 class="font-bold text-lg">Submit Request</h2><button onclick="toggleForm()" class="text-gray-400 hover:text-white text-xl">Ã—</button></div>
        <div class="p-6 space-y-4 flex-1 overflow-y-auto">
            <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Type</label><div class="grid grid-cols-3 gap-2"><label class="cursor-pointer"><input type="radio" name="cat" value="Feature" class="peer sr-only" checked><div class="text-center text-xs border rounded p-2 peer-checked:bg-blue-600 peer-checked:text-white hover:bg-gray-50 font-bold">Feature</div></label><label class="cursor-pointer"><input type="radio" name="cat" value="Bug" class="peer sr-only"><div class="text-center text-xs border rounded p-2 peer-checked:bg-red-600 peer-checked:text-white hover:bg-gray-50 font-bold">Bug</div></label><label class="cursor-pointer"><input type="radio" name="cat" value="Goal" class="peer sr-only"><div class="text-center text-xs border rounded p-2 peer-checked:bg-purple-100 peer-checked:text-purple-800 hover:bg-gray-50 font-bold">Goal</div></label></div></div>
            <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Priority</label><select id="inp-prio" class="w-full border p-2 rounded text-sm bg-white"><option value="Low">Low</option><option value="Med" selected>Medium</option><option value="High">High</option></select></div>
            <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Title</label><input type="text" id="inp-title" class="w-full border p-2 rounded text-sm font-bold"></div>
            <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Description</label><textarea id="inp-desc" class="w-full border p-2 rounded text-sm h-32"></textarea></div>
        </div>
        <div class="p-6 border-t border-gray-200 bg-gray-50 shrink-0"><button onclick="submitItem()" id="btn-submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded shadow transition">SUBMIT ITEM</button></div>
    </div>

    <!-- TICKET MODAL -->
    <div id="ticket-modal" class="fixed inset-0 z-40 hidden flex items-center justify-center bg-black/75 backdrop-blur-sm p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col overflow-hidden">
            <div class="bg-gray-50 px-6 py-4 border-b border-gray-200 flex justify-between items-start shrink-0"><div><div class="flex items-center gap-2 mb-1"><span id="t-id" class="text-[9px] font-bold bg-gray-200 text-gray-600 px-1.5 rounded border border-gray-300 font-mono">ID</span><span id="t-cat" class="text-[9px] font-bold uppercase tracking-wide">CAT</span></div><h2 id="t-title" class="text-xl font-black text-gray-900 leading-tight">Ticket Title</h2></div><button onclick="closeTicket()" class="text-gray-400 hover:text-red-500 text-2xl font-bold leading-none">&times;</button></div>
            <div class="flex-1 overflow-y-auto p-6 space-y-6"><div><h4 class="text-xs font-bold text-gray-400 uppercase mb-1">Description</h4><p id="t-desc" class="text-sm text-gray-700 whitespace-pre-wrap bg-gray-50 p-3 rounded border border-gray-100"></p></div><div><h4 class="text-xs font-bold text-gray-400 uppercase mb-2">Activity History</h4><div id="t-history" class="space-y-3"></div></div></div>
            <div class="bg-gray-100 px-6 py-4 border-t border-gray-200 shrink-0"><label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Add Update / Change Status</label><div class="flex gap-2"><select id="t-new-status" class="bg-white border border-gray-300 text-xs font-bold rounded px-2 py-2 w-32"><option value="">No Change</option><option value="Pending">Move: Pending</option><option value="In Progress">Move: Doing</option><option value="Complete">Move: Done</option></select><input type="text" id="t-comment" placeholder="Add a note..." class="flex-1 border border-gray-300 rounded px-3 text-sm focus:border-blue-500 outline-none"><button onclick="postUpdate()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold px-4 rounded text-xs">POST</button></div></div>
        </div>
    </div>

    <!-- NEW: CHANGELOG PANEL -->
    <div id="changelog-panel" class="fixed inset-y-0 right-0 w-[500px] max-w-full bg-white shadow-2xl border-l border-gray-200 z-50 slide-panel closed flex flex-col font-sans transition-transform duration-300 ease-in-out">
        <div class="p-6 bg-gray-900 text-white flex justify-between items-center shrink-0 shadow-md">
            <div>
                <h2 class="font-bold text-lg">System Changelog</h2>
                <p class="text-[10px] text-gray-400 uppercase tracking-wider">Live Sync: GitHub Repository</p>
            </div>
            <button onclick="toggleChangelog()" class="text-gray-400 hover:text-white text-xl">Ã—</button>
        </div>
        
        <div id="changelog-list" class="flex-1 overflow-y-auto bg-gray-100 p-4 space-y-4 custom-scroll">
            <div class="text-center p-10 text-gray-400 italic text-xs">Loading history...</div>
        </div>
    </div>

<script>
    const user = sessionStorage.getItem('signos_user') || 'Guest';
    let currentTicketId = null;
    let allRoadmapData = [];
    let activeFilters = { users: [], cats: [], prios: [] };

    window.onload = function() {
        if(sessionStorage.getItem('signos_role') === 'VIEW') { /* Viewer lock */ }
        loadData();
    };

    function toggleForm() { document.getElementById('side-form').classList.toggle('closed'); }
    function goBack() { window.history.back(); }
    function val(obj, key) { if(!obj) return ""; return obj[key] || obj[key.toUpperCase()] || obj[key.toLowerCase()] || ""; }

    async function loadData() {
        try {
            const response = await fetch(`${SCRIPT_URL}?req=table&tab=SYS_Roadmap&ip=${clientIP}&user=${user}`);
            const data = await response.json();
            if(data.error) throw new Error(data.error);
            allRoadmapData = data;
            initUserFilters(data);
            applyFilters();
        } catch(e) { console.error(e); }
    }

    function initUserFilters(data) {
        const users = [...new Set(data.map(i => val(i, 'User')))].filter(Boolean).sort();
        const container = document.getElementById('filter-users');
        container.innerHTML = "";
        users.forEach(u => {
            const btn = document.createElement('button');
            btn.className = "filter-chip chip-user";
            btn.innerText = u;
            btn.onclick = (e) => toggleFilter('users', u, e.target);
            container.appendChild(btn);
        });
    }

    function toggleFilter(type, value, btnElement) {
        const arr = activeFilters[type === 'cat' ? 'cats' : (type === 'prio' ? 'prios' : 'users')];
        const idx = arr.indexOf(value);
        if(idx === -1) { arr.push(value); btnElement.classList.add('active'); }
        else { arr.splice(idx, 1); btnElement.classList.remove('active'); }
        applyFilters();
    }

    function resetFilters() {
        activeFilters = { users: [], cats: [], prios: [] };
        document.getElementById('filter-search').value = "";
        document.getElementById('date-start').value = "";
        document.getElementById('date-end').value = "";
        document.querySelectorAll('.filter-chip').forEach(b => b.classList.remove('active'));
        applyFilters();
    }

    function applyFilters() {
        const search = document.getElementById('filter-search').value.toLowerCase();
        const dStart = document.getElementById('date-start').valueAsDate;
        const dEnd = document.getElementById('date-end').valueAsDate;

        const filtered = allRoadmapData.filter(item => {
            const txt = (val(item,'Title') + " " + val(item,'Description') + " " + val(item,'ID')).toLowerCase();
            if(search && !txt.includes(search)) return false;
            if(activeFilters.users.length > 0 && !activeFilters.users.includes(val(item,'User'))) return false;
            if(activeFilters.cats.length > 0 && !activeFilters.cats.includes(val(item,'Category'))) return false;
            if(activeFilters.prios.length > 0 && !activeFilters.prios.includes(val(item,'Priority'))) return false;
            if(dStart || dEnd) {
                const itemDate = new Date(val(item, 'Timestamp'));
                if(dStart && itemDate < dStart) return false;
                if(dEnd) { const endLimit = new Date(dEnd); endLimit.setHours(23,59,59); if(itemDate > endLimit) return false; }
            }
            return true;
        });
        renderBoard(filtered);
    }

    function renderBoard(data) {
        const cols = { pending: document.getElementById('col-pending'), progress: document.getElementById('col-progress'), done: document.getElementById('col-done') };
        Object.values(cols).forEach(el => el.innerHTML = "");
        let counts = { pending:0, progress:0, done:0 };

        data.forEach(item => {
            const id = val(item, 'ID');
            if(!id) return;
            const card = document.createElement('div');
            const prio = val(item, 'Priority'); const cat = val(item, 'Category');
            let borderClass = prio === 'High' ? 'card-high' : (prio === 'Low' ? 'card-low' : 'card-med');
            let catColor = cat === 'Bug' ? "bg-red-100 text-red-800" : (cat === 'Goal' ? "bg-purple-100 text-purple-800" : "bg-blue-100 text-blue-800");
            
            card.className = `draggable-card bg-white p-4 rounded shadow-sm hover:shadow-md transition cursor-grab ${borderClass} border-l-4 group relative`;
            card.draggable = true; card.id = `card-${id}`;
            card.ondragstart = (e) => drag(e, id);
            card.onclick = (e) => { if(!card.classList.contains('dragging')) openTicket(id); };

            card.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <span class="text-[9px] font-bold uppercase ${catColor} px-1.5 py-0.5 rounded">${cat}</span>
                    <span class="text-[9px] text-gray-400 group-hover:text-blue-500">View â†’</span>
                </div>
                <h3 class="font-bold text-sm text-gray-900 leading-tight mb-1 pointer-events-none">${val(item, 'Title')}</h3>
                <p class="text-xs text-gray-500 line-clamp-2 pointer-events-none">${val(item, 'Description')}</p>
                <div class="mt-2 pt-2 border-t border-gray-50 flex justify-between items-center pointer-events-none">
                    <div class="flex flex-col"><span class="text-[9px] font-bold text-gray-400 uppercase">${val(item, 'User')}</span><span class="text-[8px] text-gray-300">${new Date(val(item, 'Timestamp')).toLocaleDateString()}</span></div>
                    <span class="text-[9px] font-mono text-gray-300">${id}</span>
                </div>`;

            const status = String(val(item, 'Status')).toLowerCase().trim();
            if(status.includes('progress') || status.includes('doing')) { cols.progress.appendChild(card); counts.progress++; }
            else if(status.includes('complete') || status.includes('done')) { cols.done.appendChild(card); counts.done++; }
            else { cols.pending.appendChild(card); counts.pending++; }
        });
        document.getElementById('count-pending').innerText = counts.pending;
        document.getElementById('count-progress').innerText = counts.progress;
        document.getElementById('count-done').innerText = counts.done;
    }

    function drag(ev, id) { ev.dataTransfer.setData("text", id); ev.target.classList.add('dragging'); }
    function allowDrop(ev) { ev.preventDefault(); }
    function dragEnter(ev) { ev.preventDefault(); ev.currentTarget.classList.add('drop-active'); }
    function dragLeave(ev) { ev.currentTarget.classList.remove('drop-active'); }
    async function drop(ev, newStatusLabel) {
        ev.preventDefault(); ev.currentTarget.classList.remove('drop-active');
        const cardId = ev.dataTransfer.getData("text");
        const cardEl = document.getElementById(`card-${cardId}`);
        if (!cardEl) return;
        cardEl.classList.remove('dragging');
        ev.currentTarget.querySelector('.kanban-col').prepend(cardEl);
        try {
            const comment = `Status changed to ${newStatusLabel} (Drag & Drop)`;
            await fetch(`${SCRIPT_URL}?req=add_action&id=${cardId}&user=${user}&type=Status Update&msg=${encodeURIComponent(comment)}&new_status=${newStatusLabel}`);
            const item = allRoadmapData.find(i => val(i,'ID') === cardId); if(item) item.Status = newStatusLabel; applyFilters();
        } catch(e) { alert("Sync Failed"); applyFilters(); }
    }

    async function openTicket(id) {
        currentTicketId = id;
        document.getElementById('ticket-modal').classList.remove('hidden');
        document.body.classList.add('modal-active');
        document.getElementById('t-title').innerText = "Loading...";
        document.getElementById('t-history').innerHTML = '<div class="text-center text-gray-400 text-xs py-4">Fetching details...</div>';
        try {
            const res = await fetch(`${SCRIPT_URL}?req=get_ticket&id=${id}`);
            const data = await res.json();
            if(data.status === 'success') {
                const t = data.ticket;
                document.getElementById('t-title').innerText = val(t, 'Title');
                document.getElementById('t-desc').innerText = val(t, 'Description') || "No description.";
                document.getElementById('t-id').innerText = val(t, 'ID');
                document.getElementById('t-cat').innerText = val(t, 'Category');
                const histDiv = document.getElementById('t-history');
                histDiv.innerHTML = "";
                if(!data.history || data.history.length === 0) histDiv.innerHTML = '<div class="text-center text-gray-400 italic text-xs">No updates yet.</div>';
                else {
                    data.history.forEach(act => {
                        const d = new Date(val(act, 'Timestamp')).toLocaleString();
                        const row = document.createElement('div');
                        row.className = "flex gap-3 text-xs";
                        row.innerHTML = `<div class="font-bold text-gray-600 w-24 shrink-0 text-right">${val(act, 'User')}<br><span class="font-normal text-[9px] text-gray-400">${d}</span></div><div class="flex-1 bg-gray-50 p-2 rounded border border-gray-100 text-gray-700"><p>${val(act, 'Details')}</p>${val(act, 'Type')!=='Comment'?`<span class="bg-yellow-100 text-yellow-800 px-1 rounded text-[9px] font-bold mt-1 inline-block">${val(act, 'Type')}</span>`:''}</div>`;
                        histDiv.appendChild(row);
                    });
                }
            }
        } catch(e) { alert("Error: " + e.message); closeTicket(); }
    }
    function closeTicket() { document.getElementById('ticket-modal').classList.add('hidden'); document.body.classList.remove('modal-active'); }
    async function postUpdate() {
        const msg = document.getElementById('t-comment').value;
        const newStatus = document.getElementById('t-new-status').value;
        if(!msg && !newStatus) return;
        const type = newStatus ? "Status Update" : "Comment";
        const txt = newStatus ? `${msg} (Moved to ${newStatus})` : msg;
        try {
            await fetch(`${SCRIPT_URL}?req=add_action&id=${currentTicketId}&user=${user}&type=${type}&msg=${encodeURIComponent(txt)}&new_status=${newStatus}`);
            document.getElementById('t-comment').value = ""; document.getElementById('t-new-status').value = "";
            openTicket(currentTicketId);
            if(newStatus) { const item = allRoadmapData.find(i => val(i,'ID') === currentTicketId); if(item) item.Status = newStatus; applyFilters(); }
        } catch(e) { alert("Post failed"); }
    }
    async function submitItem() {
        const title = document.getElementById('inp-title').value; const desc = document.getElementById('inp-desc').value; const prio = document.getElementById('inp-prio').value; const cat = document.querySelector('input[name="cat"]:checked').value; const btn = document.getElementById('btn-submit');
        if(!title) { alert("Title Required"); return; } btn.disabled = true;
        try {
            const res = await fetch(`${SCRIPT_URL}?req=add_roadmap&user=${user}&title=${encodeURIComponent(title)}&desc=${encodeURIComponent(desc)}&prio=${prio}&cat=${cat}`);
            const data = await res.json();
            if(data.status === 'success') { toggleForm(); document.getElementById('inp-title').value = ""; document.getElementById('inp-desc').value = ""; loadData(); }
        } catch(e) { alert("Error"); } finally { btn.disabled = false; }
    }

    // --- NEW: CHANGELOG LOGIC ---
    async function toggleChangelog() {
        const panel = document.getElementById('changelog-panel');
        panel.classList.toggle('closed');
        
        if (!panel.classList.contains('closed')) {
            const list = document.getElementById('changelog-list');
            try {
                // Fetch the SYS_Changelog tab
                const response = await fetch(`${SCRIPT_URL}?req=table&tab=SYS_Changelog&ip=${clientIP}&user=${user}`);
                const data = await response.json();
                
                if(!data || data.length === 0) {
                    list.innerHTML = '<div class="text-center p-10 text-gray-400 italic text-xs">No history found.</div>';
                    return;
                }

                // Sort by Date Descending (Newest Top)
                data.sort((a, b) => new Date(b.Timestamp) - new Date(a.Timestamp));

                list.innerHTML = data.map((row, index) => {
                    const d = new Date(row.Timestamp);
                    const dateStr = d.toLocaleDateString() + " " + d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                    
                    // Highlight Ticket IDs (e.g. RMP_OPS_01)
                    const msg = row.Message.replace(/(RMP_[A-Za-z0-9_]+)/g, '<span class="bg-yellow-100 text-yellow-800 px-1 rounded font-bold border border-yellow-200">$1</span>');
                    
                    return `
                        <div class="timeline-item relative pl-8 pb-6">
                            <!-- Timeline Line -->
                            <div class="timeline-line absolute left-0 top-0 bottom-0 w-8 flex justify-center">
                                <div class="w-2.5 h-2.5 rounded-full bg-blue-400 border-2 border-white shadow mt-3 z-10"></div>
                            </div>
                            
                            <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 hover:border-blue-300 transition group relative">
                                <div class="flex justify-between items-start mb-2">
                                    <div class="flex flex-col">
                                        <span class="text-[10px] font-black text-gray-900 uppercase">${row.Author}</span>
                                        <span class="text-[9px] font-mono text-gray-400">${dateStr}</span>
                                    </div>
                                    <span class="text-[9px] font-mono text-gray-400 bg-gray-100 px-1.5 rounded border border-gray-200">#${row['Commit Hash']}</span>
                                </div>
                                <p class="text-xs text-gray-700 font-medium leading-relaxed">${msg}</p>
                                <div class="mt-3 flex justify-end opacity-0 group-hover:opacity-100 transition-opacity">
                                    <a href="${row['GitHub Link']}" target="_blank" class="text-[10px] font-bold text-blue-500 hover:text-blue-700 uppercase flex items-center gap-1">
                                        View Changes <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                                    </a>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (e) {
                list.innerHTML = `<div class="p-4 text-red-500 text-xs text-center border border-red-200 bg-red-50 rounded">Error loading history: ${e.message}</div>`;
            }
        }
    }
</script>
</body>
</html>
